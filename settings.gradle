// ============================================
// Gradle JVM ë²„ì „ ê¶Œì¥ ì‚¬í•­ (ì •ë³´ ì œê³µ)
// ============================================
// ì°¸ê³ : Gradle 8.5+ëŠ” Java 21ì„ ì§€ì›í•˜ë¯€ë¡œ, Gradle ë°ëª¬ì€ Java 21ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.
// í•˜ì§€ë§Œ ë¹Œë“œ ì‹œ ì»´íŒŒì¼ëŸ¬ëŠ” java.toolchain ì„¤ì •ìœ¼ë¡œ Java 17ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
// 
// ê¶Œì¥: Gradle ë°ëª¬ë„ Java 17ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ì•ˆì •ì ì´ì§€ë§Œ,
//       Java 21ì„ ì‚¬ìš©í•´ë„ ë¹Œë“œëŠ” ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.

//def recommendedJavaVersion = '17'
//def currentJavaVersion = JavaVersion.current().majorVersion
//
//if (currentJavaVersion != recommendedJavaVersion) {
//    println ""
//    println "============================================================"
//    println "â„¹ï¸  Gradle JVM ë²„ì „ ì •ë³´ (Java ${currentJavaVersion} ê°ì§€)"
//    println "============================================================"
//    println "í˜„ì¬ Gradle ë°ëª¬ì´ Java ${currentJavaVersion}ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
//    println "ê¶Œì¥ ë²„ì „: Java ${recommendedJavaVersion}"
//    println ""
//    println "ì°¸ê³ :"
//    println "  - Gradle 8.5+ëŠ” Java 21ì„ ì§€ì›í•©ë‹ˆë‹¤."
//    println "  - ë¹Œë“œ ì‹œ ì»´íŒŒì¼ëŸ¬ëŠ” java.toolchain ì„¤ì •ìœ¼ë¡œ Java 17ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
//    println "  - Java 21ì„ ì‚¬ìš©í•´ë„ ë¹Œë“œëŠ” ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤."
//    println ""
//    println "ë” ì•ˆì •ì ì¸ ë¹Œë“œë¥¼ ì›í•˜ì‹œë©´:"
//    println "  Android Studio > Settings > Build Tools > Gradle > Gradle JDK"
//    println "  ë¥¼ Java ${recommendedJavaVersion}ë¡œ ë³€ê²½í•˜ì„¸ìš”."
//    println "============================================================"
//    println ""
//}

// ============================================
// Gradle ì„¤ì • íŒŒì¼ ê²€ì¦ (ë³€ê²½ ë°©ì§€)
// ============================================
def validateGradleWrapperProperties() {
    def wrapperPropsFile = new File(rootDir, "gradle/wrapper/gradle-wrapper.properties")
    if (!wrapperPropsFile.exists()) {
        throw new GradleException("gradle-wrapper.properties íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!")
    }
    
    def props = new Properties()
    wrapperPropsFile.withInputStream { props.load(it) }
    
    // Gradle ë²„ì „ ê²€ì¦
    def expectedGradleVersion = "8.5"
    def actualDistributionUrl = props.getProperty("distributionUrl", "")
    
    if (!actualDistributionUrl.contains("gradle-${expectedGradleVersion}")) {
        throw new GradleException("""
============================================================
ğŸš¨ gradle-wrapper.properties ë³€ê²½ ê°ì§€ ğŸš¨
============================================================
gradle-wrapper.propertiesì˜ Gradle ë²„ì „ì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.

ì˜ˆìƒ ë²„ì „: ${expectedGradleVersion}
í˜„ì¬ ì„¤ì •: ${actualDistributionUrl}

íŒ€ì› ê°„ ë¹Œë“œ ì¼ê´€ì„±ì„ ìœ„í•´ Gradle ë²„ì „ì„ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.
ì›ë˜ ë²„ì „ìœ¼ë¡œ ë˜ëŒë ¤ì£¼ì„¸ìš”.
============================================================
        """)
    }
}

def validateGradleProperties() {
    def gradlePropsFile = new File(rootDir, "gradle.properties")
    if (!gradlePropsFile.exists()) {
        throw new GradleException("gradle.properties íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!")
    }
    
    def props = new Properties()
    gradlePropsFile.withInputStream { props.load(it) }
    
    // í•„ìˆ˜ ì„¤ì • ê²€ì¦
    def requiredSettings = [
        "org.gradle.jvmargs": "-Xmx4g",
        "android.useAndroidX": "true",
        "android.enableJetifier": "true"
    ]
    
    def missingOrChanged = []
    requiredSettings.each { key, expectedValue ->
        def actualValue = props.getProperty(key, "").trim()
        if (actualValue != expectedValue) {
            missingOrChanged.add("  - ${key}: ì˜ˆìƒ='${expectedValue}', ì‹¤ì œ='${actualValue}'")
        }
    }
    
    if (missingOrChanged.size() > 0) {
        throw new GradleException("""
============================================================
ğŸš¨ gradle.properties ë³€ê²½ ê°ì§€ ğŸš¨
============================================================
gradle.propertiesì˜ í•„ìˆ˜ ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤:

${missingOrChanged.join("\n")}

íŒ€ì› ê°„ ë¹Œë“œ ì¼ê´€ì„±ì„ ìœ„í•´ ì´ ì„¤ì •ë“¤ì„ ë³€ê²½í•˜ì§€ ë§ˆì„¸ìš”.
ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë ¤ì£¼ì„¸ìš”.
============================================================
        """)
    }
    
    // ê¸ˆì§€ëœ ì„¤ì • ê²€ì¦ (ë¡œì»¬ ê²½ë¡œ ë“±)
    def forbiddenKeys = ["org.gradle.java.home"]
    forbiddenKeys.each { key ->
        if (props.containsKey(key)) {
            throw new GradleException("""
============================================================
ğŸš¨ gradle.propertiesì— ê¸ˆì§€ëœ ì„¤ì • ë°œê²¬ ğŸš¨
============================================================
gradle.propertiesì— '${key}' ì„¤ì •ì´ ìˆìŠµë‹ˆë‹¤.

ì´ ì„¤ì •ì€ ë¡œì»¬ ê²½ë¡œë¥¼ í¬í•¨í•˜ë¯€ë¡œ íŒ€ì› ê°„ ê³µìœ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
í•´ë‹¹ ë¼ì¸ì„ ì œê±°í•´ì£¼ì„¸ìš”.
============================================================
            """)
        }
    }
}

// ê²€ì¦ ì‹¤í–‰
validateGradleWrapperProperties()
validateGradleProperties()

// ============================================
// local.properties ìë™ ìƒì„± ë¡œì§
// ============================================

def localPropertiesFile = new File(rootDir, "local.properties")
def localPropertiesTemplate = new File(rootDir, "local.properties.template")

if (!localPropertiesFile.exists()) {
    if (localPropertiesTemplate.exists()) {
        println ""
        println "=========================================="
        println "âš ï¸  local.properties íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        println "ğŸ“‹ í…œí”Œë¦¿ì—ì„œ ìë™ìœ¼ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤..."
        println "=========================================="
        
        // í…œí”Œë¦¿ ë³µì‚¬
        localPropertiesTemplate.withInputStream { input ->
            localPropertiesFile.withOutputStream { output ->
                output << input
            }
        }
        
        println "âœ… local.properties ìƒì„± ì™„ë£Œ!"
        println ""
        println "âš ï¸  ì¤‘ìš”: ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•˜ì„¸ìš”:"
        println "   1. local.properties íŒŒì¼ì„ ì—¬ì„¸ìš”"
        println "   2. sdk.dirì„ ë³¸ì¸ì˜ Android SDK ê²½ë¡œë¡œ ìˆ˜ì •í•˜ì„¸ìš”"
        println ""
        println "ğŸ“ SDK ê²½ë¡œ ì°¾ê¸°:"
        println "   - macOS: ~/Library/Android/sdk"
        println "   - Windows: C:\\Users\\ë³¸ì¸ì•„ì´ë””\\AppData\\Local\\Android\\Sdk"
        println ""
        println "ë¹Œë“œë¥¼ ê³„ì†í•˜ë ¤ë©´ ê²½ë¡œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ë¹Œë“œí•˜ì„¸ìš”."
        println "=========================================="
        println ""
        
        // ê¸°ë³¸ ì„¤ì • ì™„ë£Œ (ê²½ë¡œ ê²€ì¦ ìƒëµ)
    } else {
        throw new GradleException(
            "\nâŒ local.propertiesì™€ local.properties.template ëª¨ë‘ ì—†ìŠµë‹ˆë‹¤!\n" +
            "Gitì—ì„œ ìµœì‹  ì½”ë“œë¥¼ ë°›ì•„ì£¼ì„¸ìš”: git pull origin front\n"
        )
    }
}

// ============================================

include ':app', ':OpenCV'
